<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RabbitMQ Visualizer</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header>
    <h1>RabbitMQ Visualizer</h1>
    <div class="controls">
      <input id="count" type="number" value="50" min="1" />
      <button id="sendBatch">Send Batch</button>
      <button id="sendSmall">Send 10</button>
      <span class="active-queue">Active: <strong id="active-queue-label">Emails</strong></span>
      <a class="link" href="http://localhost:15672" target="_blank">Open RabbitMQ UI</a>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="emails" id="tab-btn-emails">Emails</button>
      <button class="tab" data-tab="images" id="tab-btn-images">Images</button>
      <button class="tab" data-tab="inscriptions" id="tab-btn-inscriptions">Inscriptions</button>
    </div>
    <div class="stats">
      <span>Published: <strong id="published">0</strong></span>
      <span>Consuming: <strong id="consuming">0</strong></span>
      <span>Acked: <strong id="acked">0</strong></span>
    </div>
  </header>
  <section class="about">
    <h3>Why queues matter</h3>
    <ul>
      <li><strong>Decoupling:</strong> Producers (e.g., your app) don’t wait on consumers; they drop work into a queue and move on.</li>
      <li><strong>Buffering:</strong> Spikes get smoothed out. If you need to send 10k emails, a queue absorbs the surge.</li>
      <li><strong>Reliability:</strong> If a worker dies, messages remain in the queue until another worker handles them.</li>
      <li><strong>Scalability:</strong> Add more consumers to increase throughput without changing producers.</li>
      <li><strong>Back-pressure:</strong> Consumers pull at their own pace, preventing overloads.</li>
    </ul>
    <h3>What this demo shows</h3>
    <ul>
      <li><strong>Producer:</strong> When you click “Send”, envelopes are <em>published</em> to the queue.</li>
      <li><strong>Queue:</strong> Envelopes briefly sit here, representing RabbitMQ storing messages.</li>
      <li><strong>Consumers:</strong> Workers <em>consume</em> messages, simulate processing, and <em>ack</em> them.</li>
      <li><strong>Counters:</strong> Live totals of Published, currently Consuming, and Acked.</li>
    </ul>
    <p>
      This mirrors real-world email/newsletter pipelines: the web app enqueues email jobs, background workers send them, and the queue provides resilience and smooth throughput.
    </p>
  </section>
  <section class="telemetry">
    <div class="cpu-panel">
      <div class="cpu-header">
        <h3>Server CPU (simulated)</h3>
        <span id="cpu-label">0%</span>
      </div>
      <div class="cpu-bar">
        <div class="cpu-fill" id="cpu-fill" style="width:0%"></div>
      </div>
      <div class="intensity">
        <label for="intensity">Work intensity</label>
        <input id="intensity" type="range" min="0" max="1" step="0.01" value="0.5" />
        <span id="intensity-val">0.50</span>
      </div>
      <div class="queue-meta">
        <span>In-flight: <strong id="inflight">0</strong></span>
        <span>Queue depth: <strong id="qdepth">0</strong></span>
      </div>
    </div>
  </section>

  <main id="tab-emails" class="tab-content">
    <div class="lane producer">
      <h2>Producer</h2>
      <div class="stage" id="emails-stage-producer"></div>
    </div>
    <div class="lane queue">
      <h2>Queue</h2>
      <div class="stage" id="emails-stage-queue"></div>
    </div>
    <div class="lane consumers">
      <h2>Consumers</h2>
      <div class="stage" id="emails-stage-consumers"></div>
    </div>
  </main>

  <main id="tab-inscriptions" class="tab-content hidden">
    <div class="insc-grid">
      <div class="panel">
        <h2>Batch Release Controller</h2>
        <div class="insc-controls">
          <label>Students total
            <input id="insc-total" type="number" value="30000" min="1" />
          </label>
          <label>Batch size
            <input id="insc-batch" type="number" value="500" min="1" />
          </label>
          <label>Interval (seconds)
            <input id="insc-interval" type="number" value="5" min="1" />
          </label>
          <div class="btn-row">
            <button id="insc-start">Start batching</button>
            <button id="insc-stop" class="secondary">Stop</button>
            <button id="insc-once" class="secondary">Release once</button>
            <button id="insc-reset" class="secondary">Reset</button>
          </div>
        </div>

        <div class="bars">
          <div class="bar">
            <span>Released</span>
            <div class="bar-outer"><div id="bar-released" class="bar-fill" style="width:0%"></div></div>
            <span id="bar-released-label">0%</span>
          </div>
          <div class="bar">
            <span>Processed (acked)</span>
            <div class="bar-outer"><div id="bar-processed" class="bar-fill blue" style="width:0%"></div></div>
            <span id="bar-processed-label">0%</span>
          </div>
          <div class="bar">
            <span>Queue depth</span>
            <div class="bar-outer"><div id="bar-queue" class="bar-fill amber" style="width:0%"></div></div>
            <span id="bar-queue-label">0%</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>CPU & Spikes</h2>
        <div class="cpu-mini">
          <div class="cpu-bar mini"><div id="cpu-mini-fill" class="cpu-fill" style="width:0%"></div></div>
          <span id="cpu-mini-label">0%</span>
        </div>
        <div class="spikes">
          <div class="spikes-header">
            <span>Spikes over threshold</span>
            <div>
              <label>Threshold % <input id="spike-threshold" type="number" value="85" min="1" max="100" /></label>
              <button id="spikes-clear" class="secondary">Clear</button>
            </div>
          </div>
          <ul id="spikes-list" class="spikes-list"></ul>
        </div>
      </div>
    </div>
  </main>

  <main id="tab-images" class="tab-content hidden">
    <div class="lane producer">
      <h2>Producer</h2>
      <div class="stage" id="images-stage-producer"></div>
    </div>
    <div class="lane queue">
      <h2>Queue</h2>
      <div class="stage" id="images-stage-queue"></div>
    </div>
    <div class="lane consumers">
      <h2>Consumers</h2>
      <div class="stage" id="images-stage-consumers"></div>
    </div>
  </main>

  <footer>
    <small>Demo: envelopes move Producer → Queue → Consumers as messages flow.</small>
  </footer>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/app.js"></script>
</body>
</html>
